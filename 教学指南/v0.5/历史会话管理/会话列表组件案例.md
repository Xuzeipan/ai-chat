# 历史会话管理案例

## 基础实现

### 1. 创建会话列表组件

```tsx
// src/components/ChatSidebar/ChatSidebar.tsx
import { useState } from 'react';
import { ChatSession, deleteSession, updateSessionTitle } from '../../services/chat.js';

interface ChatSidebarProps {
  sessions: ChatSession[];
  currentSessionId?: string;
  onSelectSession: (id: string) => void;
  onCreateSession: () => void;
  onDeleteSession: () => void;
}

export function ChatSidebar({
  sessions,
  currentSessionId,
  onSelectSession,
  onCreateSession,
  onDeleteSession
}: ChatSidebarProps) {
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editTitle, setEditTitle] = useState('');

  const handleEdit = (session: ChatSession) => {
    setEditingId(session.id);
    setEditTitle(session.title);
  };

  const handleSaveTitle = async (id: string) => {
    try {
      await updateSessionTitle(id, editTitle);
      setEditingId(null);
      // 通知父组件刷新列表
      onDeleteSession();
    } catch (error) {
      console.error('保存失败:', error);
    }
  };

  const handleDelete = async (id: string) => {
    if (!confirm('确定删除此会话吗？')) return;
    try {
      await deleteSession(id);
      onDeleteSession();
    } catch (error) {
      console.error('删除失败:', error);
    }
  };

  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));

    if (days === 0) {
      return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    } else if (days === 1) {
      return '昨天';
    } else if (days < 7) {
      return `${days} 天前`;
    } else {
      return date.toLocaleDateString('zh-CN');
    }
  };

  return (
    <aside className="w-64 bg-base-200 h-full flex flex-col">
      {/* 新建会话按钮 */}
      <div className="p-4">
        <button
          className="btn btn-primary w-full"
          onClick={onCreateSession}
        >
          + 新建对话
        </button>
      </div>

      {/* 会话列表 */}
      <div className="flex-1 overflow-y-auto px-2">
        {sessions.length === 0 ? (
          <div className="text-center text-base-content/50 py-8">
            暂无会话
          </div>
        ) : (
          <div className="space-y-1">
            {sessions.map((session) => (
              <div
                key={session.id}
                className={`group relative p-3 rounded-lg cursor-pointer hover:bg-base-300 ${
                  session.id === currentSessionId ? 'bg-base-300' : ''
                }`}
                onClick={() => onSelectSession(session.id)}
              >
                {editingId === session.id ? (
                  <input
                    type="text"
                    className="input input-sm input-bordered w-full"
                    value={editTitle}
                    onChange={(e) => setEditTitle(e.target.value)}
                    onBlur={() => handleSaveTitle(session.id)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') handleSaveTitle(session.id);
                      if (e.key === 'Escape') setEditingId(null);
                    }}
                    autoFocus
                    onClick={(e) => e.stopPropagation()}
                  />
                ) : (
                  <>
                    <div className="font-medium truncate pr-8">
                      {session.title}
                    </div>
                    <div className="text-xs text-base-content/50 flex justify-between">
                      <span>{session.provider}</span>
                      <span>{formatDate(session.updatedAt)}</span>
                    </div>

                    {/* 操作按钮 */}
                    <div className="absolute right-2 top-2 hidden group-hover:flex gap-1">
                      <button
                        className="btn btn-xs btn-ghost"
                        onClick={(e) => {
                          e.stopPropagation();
                          handleEdit(session);
                        }}
                      >
                        编辑
                      </button>
                      <button
                        className="btn btn-xs btn-ghost text-error"
                        onClick={(e) => {
                          e.stopPropagation();
                          handleDelete(session.id);
                        }}
                      >
                        删除
                      </button>
                    </div>
                  </>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    </aside>
  );
}
```

### 2. 更新 App.tsx 添加侧边栏

```tsx
// App.tsx
import { ChatSidebar } from './components/ChatSidebar/ChatSidebar.js';

function App() {
  // ... 其他状态和逻辑

  const handleCreateSession = () => {
    setCurrentSessionId(undefined);
    setMessages([]);
    // 重置模型选择为默认
    if (sessions.length > 0) {
      const lastSession = sessions[0];
      setSelectedModel({ provider: lastSession.provider, model: lastSession.model });
    }
  };

  return (
    <div className="flex h-screen">
      {/* 侧边栏 */}
      <ChatSidebar
        sessions={sessions}
        currentSessionId={currentSessionId}
        onSelectSession={handleSelectSession}
        onCreateSession={handleCreateSession}
        onDeleteSession={loadSessions}
      />

      {/* 主聊天区域 */}
      <main className="flex-1 flex flex-col">
        {/* 顶部栏 - 显示模型选择器 */}
        <header className="p-4 border-b border-base-300 flex justify-between items-center">
          <div className="text-lg font-bold">
            {currentSessionId
              ? sessions.find((s) => s.id === currentSessionId)?.title || '聊天'
              : '新对话'}
          </div>
          <ModelSelector
            value={selectedModel}
            onChange={setSelectedModel}
          />
        </header>

        {/* 消息列表 */}
        <ChatList messages={messages} />

        {/* 输入框 */}
        <ChatInput onSend={handleSendMessage} />
      </main>
    </div>
  );
}
```

## 使用示例

### 会话管理流程

1. **创建会话**: 点击「新建对话」按钮，清空当前消息，可以开始新对话
2. **切换会话**: 点击侧边栏的会话，加载历史消息
3. **编辑标题**: 点击「编辑」按钮，修改会话标题
4. **删除会话**: 点击「删除」按钮，删除不需要的会话

### 日期显示规则

| 时间 | 显示 |
|------|------|
| 今天 | HH:mm |
| 昨天 | "昨天" |
| 7天内 | "N 天前" |
| 更早 | YYYY-MM-DD |

## 原理解释

### 会话状态流转

```
新建会话 -> 输入消息 -> Server 返回 sessionId -> 保存到 currentSessionId
         -> 刷新会话列表
```

### 条件渲染

```tsx
{editingId === session.id ? (
  <input ... />  // 编辑模式
) : (
  <>...显示模式...</>
)}
```

根据 `editingId` 决定是显示输入框还是会话信息。

## 进阶功能

### 会话搜索

```tsx
const [searchQuery, setSearchQuery] = useState('');

const filteredSessions = sessions.filter((s) =>
  s.title.toLowerCase().includes(searchQuery.toLowerCase())
);
```

### 会话分组

```typescript
// 按日期分组
const groupedSessions = sessions.reduce((groups, session) => {
  const date = new Date(session.updatedAt).toDateString();
  if (!groups[date]) groups[date] = [];
  groups[date].push(session);
  return groups;
}, {} as Record<string, ChatSession[]>);
```

## 你的任务

1. 创建 `src/components/ChatSidebar/ChatSidebar.tsx` 会话列表组件
2. 修改 `App.tsx` 添加侧边栏布局和会话管理功能
3. 测试完整的会话管理流程（创建、切换、编辑、删除）

完成后告诉我，我帮你检查。
