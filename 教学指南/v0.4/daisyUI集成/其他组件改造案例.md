# å…¶ä»–ç»„ä»¶æ”¹é€ æ¡ˆä¾‹

ç»§ç»­æ”¹é€  MessageBubbleã€ChatListã€ModeSelector å’Œ MarkdownRenderer ç»„ä»¶ã€‚

## 1. MessageBubble æ”¹é€ 

daisyUI å†…ç½®äº† `chat` ç»„ä»¶ï¼Œéå¸¸é€‚åˆèŠå¤©æ°”æ³¡åœºæ™¯ã€‚

### æ”¹é€ å‰

```tsx
import type { Message } from "../../types";
import styles from "./MessageBubble.module.css";
import { MarkdownRenderer } from "../MarkdownRenderer/MarkdownRenderer";

interface MessageBubbleProps {
  message: Message;
}

export function MessageBubble({ message }: MessageBubbleProps) {
  const isUser = message.role === "user";

  return (
    <div className={`${styles.message} ${styles[message.role]}`}>
      <div className={styles.bubble}>
        {isUser ? (
          <span>{message.content}</span>
        ) : (
          <MarkdownRenderer content={message.content} />
        )}
      </div>
    </div>
  );
}
```

### æ”¹é€ å

```tsx
import type { Message } from "../../types";
import { MarkdownRenderer } from "../MarkdownRenderer/MarkdownRenderer";

interface MessageBubbleProps {
  message: Message;
}

export function MessageBubble({ message }: MessageBubbleProps) {
  const isUser = message.role === "user";

  return (
    <div className={`chat ${isUser ? "chat-end" : "chat-start"} animate-fade-in`}>
      <div className={`chat-bubble ${isUser ? "chat-bubble-primary" : "bg-base-200 text-base-content"}`}>
        {isUser ? (
          <span>{message.content}</span>
        ) : (
          <MarkdownRenderer content={message.content} />
        )}
      </div>
    </div>
  );
}
```

### è¯´æ˜

| åŸ CSS | daisyUI ç±»å | ä½œç”¨ |
|--------|-------------|------|
| `display: flex` + `justify-content: flex-end/flex-start` | `chat-start` / `chat-end` | æ§åˆ¶æ°”æ³¡å·¦å³ä½ç½® |
| `max-width: 70%` + `border-radius` | `chat-bubble` | æ°”æ³¡æ ·å¼ |
| `background-color: var(--primary-color)` | `chat-bubble-primary` | ç”¨æˆ·æ¶ˆæ¯ä¸»é¢˜è‰² |
| `background-color: var(--surface-color)` | `bg-base-200` | AI æ¶ˆæ¯èƒŒæ™¯è‰² |
| `@keyframes fadeIn` | `animate-fade-in` | æ·¡å…¥åŠ¨ç”»ï¼ˆéœ€è¦é…ç½®ï¼‰ |

**åˆ é™¤æ–‡ä»¶**: `MessageBubble.module.css`

---

## 2. ChatList æ”¹é€ 

### æ”¹é€ å‰

```tsx
import { useEffect, useRef } from "react";
import type { Message } from "../../types";
import styles from "./ChatList.module.css";
import { MessageBubble } from "../MessageBubble/MessageBubble";

interface ChatListProps {
  messages: Message[];
  isLoading?: boolean;
}

export function ChatList({ messages, isLoading = false }: ChatListProps) {
  const listRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (listRef.current) {
      listRef.current.scrollTop = listRef.current.scrollHeight;
    }
  }, [messages]);

  return (
    <div className={styles.chatlist} ref={listRef}>
      {messages.length === 0 ? (
        <div className={styles.empty}>æš‚æ— æ¶ˆæ¯</div>
      ) : (
        <>
          {messages
            .filter((msg) => msg.content)
            .map((message) => (
              <MessageBubble key={message.id} message={message} />
            ))}
          {isLoading && (
            <div className={styles.loading}>
              <div className={styles.typingIndicator}>
                <span></span>
                <span></span>
                <span></span>
              </div>
              <span className={styles.loadingText}>AI æ­£åœ¨æ€è€ƒ...</span>
            </div>
          )}
        </>
      )}
    </div>
  );
}
```

### æ”¹é€ å

```tsx
import { useEffect, useRef } from "react";
import type { Message } from "../../types";
import { MessageBubble } from "../MessageBubble/MessageBubble";

interface ChatListProps {
  messages: Message[];
  isLoading?: boolean;
}

export function ChatList({ messages, isLoading = false }: ChatListProps) {
  const listRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (listRef.current) {
      listRef.current.scrollTop = listRef.current.scrollHeight;
    }
  }, [messages]);

  return (
    <div
      className="flex-1 overflow-y-auto py-4 scroll-smooth bg-base-100"
      ref={listRef}
    >
      {messages.length === 0 ? (
        <div className="flex flex-col items-center justify-center h-full text-base-content/50">
          <span className="text-5xl mb-3 opacity-50">ğŸ’¬</span>
          <span>æš‚æ— æ¶ˆæ¯</span>
        </div>
      ) : (
        <div className="space-y-4 px-4">
          {messages
            .filter((msg) => msg.content)
            .map((message) => (
              <MessageBubble key={message.id} message={message} />
            ))}
          {isLoading && (
            <div className="flex items-center gap-2 px-4 py-3 text-base-content/60 text-sm">
              <span className="loading loading-dots loading-sm"></span>
              <span className="animate-pulse">AI æ­£åœ¨æ€è€ƒ...</span>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

### è¯´æ˜

| åŸ CSS | Tailwind ç±»å | ä½œç”¨ |
|--------|--------------|------|
| `flex: 1` | `flex-1` | å æ®å‰©ä½™ç©ºé—´ |
| `overflow-y: auto` | `overflow-y-auto` | å‚ç›´æ»šåŠ¨ |
| `padding: 16px 0` | `py-4` | å‚ç›´å†…è¾¹è· |
| `scroll-behavior: smooth` | `scroll-smooth` | å¹³æ»‘æ»šåŠ¨ |
| `background-color: var(--background-color)` | `bg-base-100` | èƒŒæ™¯è‰² |
| è‡ªå®šä¹‰ loading åŠ¨ç”» | `loading loading-dots` | daisyUI åŠ è½½åŠ¨ç”» |
| è‡ªå®šä¹‰ pulse åŠ¨ç”» | `animate-pulse` | Tailwind å†…ç½®åŠ¨ç”» |

**åˆ é™¤æ–‡ä»¶**: `ChatList.module.css`

---

## 3. ModeSelector æ”¹é€ 

### æ”¹é€ å‰

```tsx
import type { Mode } from "../../types";
import styles from "./ModeSelector.module.css";

interface ModeSelectorProps {
  modes: Mode[];
  currentMode: Mode;
  onModeChange: (mode: Mode) => void;
}

export function ModeSelector({
  modes,
  currentMode,
  onModeChange,
}: ModeSelectorProps) {
  return (
    <div className={styles.modeSelector}>
      {modes.map((mode) => (
        <button
          key={mode.id}
          className={`${styles.modeButton} ${mode.id === currentMode.id ? styles.active : ""}`}
          onClick={() => onModeChange(mode)}
          title={mode.description}
        >
          <span className={styles.modeIcon}>{mode.icon || "ğŸ’¬"}</span>
          <span className={styles.modeName}>{mode.name}</span>
        </button>
      ))}
    </div>
  );
}
```

### æ”¹é€ å

```tsx
import type { Mode } from "../../types";

interface ModeSelectorProps {
  modes: Mode[];
  currentMode: Mode;
  onModeChange: (mode: Mode) => void;
}

export function ModeSelector({
  modes,
  currentMode,
  onModeChange,
}: ModeSelectorProps) {
  return (
    <div className="flex gap-2 px-4 py-3 bg-base-100 border-b border-base-300 overflow-x-auto">
      {modes.map((mode) => {
        const isActive = mode.id === currentMode.id;
        return (
          <button
            key={mode.id}
            className={`
              btn btn-sm gap-1.5 whitespace-nowrap
              ${isActive ? "btn-primary" : "btn-outline"}
            `}
            onClick={() => onModeChange(mode)}
            title={mode.description}
          >
            <span className="text-base">{mode.icon || "ğŸ’¬"}</span>
            <span className="hidden sm:inline">{mode.name}</span>
          </button>
        );
      })}
    </div>
  );
}
```

### è¯´æ˜

| åŸ CSS | daisyUI/Tailwind ç±»å | ä½œç”¨ |
|--------|---------------------|------|
| `display: flex` + `gap: 8px` | `flex gap-2` | æ¨ªå‘æ’åˆ— |
| `padding: 12px 16px` | `px-4 py-3` | å†…è¾¹è· |
| `border-bottom` | `border-b border-base-300` | åº•éƒ¨è¾¹æ¡† |
| `overflow-x: auto` | `overflow-x-auto` | æ¨ªå‘æ»šåŠ¨ |
| è‡ªå®šä¹‰æŒ‰é’®æ ·å¼ | `btn btn-sm` | daisyUI å°æŒ‰é’® |
| `&.active` | `btn-primary` / `btn-outline` | æ¿€æ´»/æœªæ¿€æ´»çŠ¶æ€ |
| `@media (max-width: 768px)` | `hidden sm:inline` | å“åº”å¼éšè—æ–‡å­— |

**åˆ é™¤æ–‡ä»¶**: `ModeSelector.module.css`

---

## 4. MarkdownRenderer æ”¹é€ 

### æ–¹æ¡ˆï¼šä»£ç å—ä¿æŒç°çŠ¶ï¼Œè¡¨æ ¼ä½¿ç”¨ daisyUI table ç»„ä»¶

ç”±äº Markdown æ¸²æŸ“å†…å®¹éœ€è¦é€šè¿‡ `dangerouslySetInnerHTML` æ’å…¥ï¼Œéœ€è¦ä½¿ç”¨ marked çš„è‡ªå®šä¹‰ renderer ä¸ºè¡¨æ ¼æ·»åŠ  daisyUI ç±»åã€‚

### æ”¹é€ æ­¥éª¤

#### ç¬¬1æ­¥ï¼šä¿®æ”¹ MarkdownRenderer.tsx

```tsx
import { useMemo } from "react";
import hljs from "highlight.js";
import { marked } from "marked";
import type { MarkdownRendererProps } from "../../types";
import styles from "./MarkdownRenderer.module.css";

// è‡ªå®šä¹‰ renderer
const renderer = new marked.Renderer();

// ä»£ç å— - ä¿æŒ highlight.js æ ·å¼
renderer.code = ({ text, lang }) => {
  const language = hljs.getLanguage(lang || "") ? lang || "" : "plaintext";
  const highlighted = hljs.highlight(text, { language }).value;
  return `<pre><code class="hljs language-${language}">${highlighted}</code></pre>`;
};

// è¡¨æ ¼ - ä½¿ç”¨ daisyUI table ç»„ä»¶
renderer.table = (token) => {
  // header æ˜¯ TableCell[]ï¼Œéœ€è¦æå– text
  const headerHtml = token.header
    .map((cell) => `<th>${cell.text}</th>`)
    .join("");

  // rows æ˜¯ TableCell[][]ï¼Œéœ€è¦æå– text
  const rowsHtml = token.rows
    .map((row) =>
      `<tr>${row.map((cell) => `<td>${cell.text}</td>`).join("")}</tr>`
    )
    .join("");

  return `
    <div class="overflow-x-auto my-4">
      <table class="table table-zebra w-full">
        <thead>
          <tr>${headerHtml}</tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>
    </div>
  `;
};

marked.use({ renderer });

export function MarkdownRenderer({
  content,
  className,
}: MarkdownRendererProps) {
  const htmlContent = useMemo(() => {
    return marked.parse(content) as string;
  }, [content]);

  return (
    <div
      className={`${styles.markdown} ${className || ""}`}
      dangerouslySetInnerHTML={{ __html: htmlContent }}
    />
  );
}
```

#### ç¬¬2æ­¥ï¼šä¿®æ”¹ MarkdownRenderer.module.css

ç§»é™¤è¡¨æ ¼æ ·å¼ï¼ˆå·²ç”¨ daisyUI table ç±»åï¼‰ï¼Œä¿ç•™å…¶ä»–æ ·å¼ï¼š

```css
.markdown {
  line-height: 1.6;
  font-size: 14px;
}

/* æ ‡é¢˜æ ·å¼ */
.markdown h1,
.markdown h2,
.markdown h3,
.markdown h4,
.markdown h5,
.markdown h6 {
  margin-top: 1.5em;
  margin-bottom: 0.5em;
  font-weight: 600;
}

.markdown h1 {
  font-size: 1.5em;
  border-bottom: 1px solid hsl(var(--b3));
  padding-bottom: 0.3em;
}

.markdown h2 {
  font-size: 1.25em;
}

.markdown h3 {
  font-size: 1.1em;
}

/* æ®µè½ */
.markdown p {
  margin: 0.8em 0;
}

/* åˆ—è¡¨ */
.markdown ul,
.markdown ol {
  padding-left: 1.5em;
  margin: 0.8em 0;
}

.markdown li {
  margin: 0.3em 0;
}

/* å¼•ç”¨å— - ä½¿ç”¨ daisyUI é¢œè‰²å˜é‡ */
.markdown blockquote {
  margin: 0.8em 0;
  padding: 0.75em 1em;
  border-left: 4px solid hsl(var(--p));
  background-color: hsl(var(--b2));
  border-radius: 0 var(--rounded-btn, 0.5rem) var(--rounded-btn, 0.5rem) 0;
}

/* ä»£ç å— - ä¿æŒ highlight.js æ·±è‰²èƒŒæ™¯ */
.markdown pre {
  margin: 0.8em 0;
  padding: 1em;
  background-color: #1f2937;
  border-radius: var(--rounded-btn, 0.5rem);
  overflow-x: auto;
}

.markdown code {
  font-family: "Fira Code", "Consolas", monospace;
  font-size: 0.9em;
}

/* è¡Œå†…ä»£ç  - é€‚é…ä¸»é¢˜ */
.markdown :not(pre) > code {
  background-color: hsl(var(--b2));
  padding: 0.2em 0.4em;
  border-radius: 0.25rem;
  color: hsl(var(--p));
}

/* é“¾æ¥ - ä½¿ç”¨ä¸»é¢˜è‰² */
.markdown a {
  color: hsl(var(--p));
  text-decoration: none;
}

.markdown a:hover {
  text-decoration: underline;
}

/* åˆ†å‰²çº¿ */
.markdown hr {
  border: none;
  border-top: 1px solid hsl(var(--b3));
  margin: 1.5em 0;
}

/* å›¾ç‰‡ */
.markdown img {
  max-width: 100%;
  height: auto;
  border-radius: var(--rounded-btn, 0.5rem);
}

/* è¡¨æ ¼æ ·å¼å·²ç”± daisyUI table ç±»åå¤„ç†ï¼Œæ­¤å¤„æ— éœ€å®šä¹‰ */
```

### daisyUI Table ç±»åè¯´æ˜

| ç±»å | ä½œç”¨ |
|------|------|
| `table` | åŸºç¡€è¡¨æ ¼æ ·å¼ |
| `table-zebra` | æ–‘é©¬çº¹ï¼ˆéš”è¡Œå˜è‰²ï¼‰ |
| `w-full` | å®½åº¦ 100% |
| `overflow-x-auto` | ç§»åŠ¨ç«¯æ¨ªå‘æ»šåŠ¨ |

### è¡¨æ ¼æ¸²æŸ“æ•ˆæœ

- **è¡¨å¤´**ï¼šè‡ªåŠ¨ä½¿ç”¨ daisyUI ä¸»é¢˜è‰²èƒŒæ™¯
- **æ–‘é©¬çº¹**ï¼š`table-zebra` è‡ªåŠ¨éš”è¡Œå˜è‰²
- **å“åº”å¼**ï¼š`overflow-x-auto` ç¡®ä¿ç§»åŠ¨ç«¯å¯æ»šåŠ¨
- **è¾¹æ¡†/åœ†è§’**ï¼šdaisyUI table ç»„ä»¶è‡ªå¸¦

**ä¿ç•™æ–‡ä»¶**: `MarkdownRenderer.module.css`ï¼ˆç§»é™¤è¡¨æ ¼æ ·å¼ï¼‰

---

## 5. æ·»åŠ è‡ªå®šä¹‰åŠ¨ç”»ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ `animate-fade-in` åŠ¨ç”»ï¼Œåœ¨ `index.css` ä¸­æ·»åŠ ï¼š

```css
@keyframes fade-in {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in {
  animation: fade-in 0.3s ease-out;
}
```

---

## 6. App.tsx å¸ƒå±€æ”¹é€ ï¼ˆè§£å†³æ»šåŠ¨æ¡é—®é¢˜ï¼‰

æ·»åŠ  navbar å’Œ ModeSelector åï¼Œæ•´ä½“é«˜åº¦è¶…è¿‡äº†è§†å£ï¼Œå¯¼è‡´å‡ºç°å¤–å±‚æ»šåŠ¨æ¡ã€‚éœ€è¦æ”¹é€ ä¸º Flex å¸ƒå±€è®© ChatList è‡ªé€‚åº”å¡«å……å‰©ä½™ç©ºé—´ã€‚

### æ”¹é€ å‰

```tsx
<>
  <header className="navbar bg-base-100 shadow-sm">...</header>
  <div className={styles.app}>
    <div className={styles.header}>
      <ModeSelector ... />
    </div>
    {state.error && <div className={styles.errorBanner}>...</div>}
    <ChatList messages={state.messages} isLoading={state.loading} />
    <ChatInput onSend={handleSend} isLoading={state.loading} />
  </div>
</>
```

### æ”¹é€ å

```tsx
<div className="h-screen flex flex-col bg-base-100">
  {/* é¡¶éƒ¨å¯¼èˆª */}
  <header className="navbar bg-base-100 shadow-sm flex-none">
    <div className="flex-1">
      <h1 className="text-xl font-bold">AI Chat</h1>
    </div>
    <div className="flex-none gap-2">
      <ThemeToggle />
    </div>
  </header>

  {/* æ¨¡å¼é€‰æ‹©å™¨ */}
  <ModeSelector
    modes={MODES}
    currentMode={state.currentMode}
    onModeChange={handleModeChange}
  />

  {/* é”™è¯¯æç¤º */}
  {state.error && (
    <div className="alert alert-error rounded-none flex-none">
      <span>{state.error}</span>
      <button className="btn btn-ghost btn-sm" onClick={handleClearError}>
        âœ•
      </button>
    </div>
  )}

  {/* èŠå¤©åŒºåŸŸ - å¡«å……å‰©ä½™ç©ºé—´ */}
  <ChatList messages={state.messages} isLoading={state.loading} />

  {/* è¾“å…¥æ¡† - å›ºå®šåœ¨åº•éƒ¨ */}
  <ChatInput onSend={handleSend} isLoading={state.loading} />
</div>
```

### å¸ƒå±€è¯´æ˜

| å…ƒç´  | ç±»å | ä½œç”¨ |
|------|------|------|
| å¤–å±‚å®¹å™¨ | `h-screen flex flex-col` | é™åˆ¶é«˜åº¦ä¸ºè§†å£ï¼Œçºµå‘ Flex |
| navbar | `flex-none` | ä¸ä¼¸ç¼©ï¼Œå›ºå®šé«˜åº¦ |
| ModeSelector | æ— ï¼ˆè‡ªèº«é«˜åº¦ï¼‰ | ä¸ä¼¸ç¼© |
| é”™è¯¯æç¤º | `flex-none` | ä¸ä¼¸ç¼© |
| **ChatList** | `flex-1 overflow-y-auto` | **å¡«å……å‰©ä½™ç©ºé—´ï¼Œå¯æ»šåŠ¨** |
| ChatInput | æ— ï¼ˆè‡ªèº«é«˜åº¦ï¼‰ | å›ºå®šåœ¨åº•éƒ¨ |

### å…³é”®ä¿®æ”¹

1. **ChatList ç»„ä»¶** éœ€è¦ç¡®ä¿æœ‰ `flex-1`ï¼š
   ```tsx
   <div className="flex-1 overflow-y-auto py-4 bg-base-100" ref={listRef}>
   ```

2. **åˆ é™¤** `App.module.css`ï¼ˆæˆ–æ¸…ç©ºå†…å®¹ï¼‰ï¼Œå®Œå…¨ä½¿ç”¨ Tailwind

3. **ç§»åŠ¨ç«¯é€‚é…**ï¼šä½¿ç”¨ `h-dvh` æ›¿ä»£ `h-screen` é¿å…ç§»åŠ¨ç«¯æµè§ˆå™¨å·¥å…·æ é—®é¢˜
   ```tsx
   <div className="h-screen h-dvh flex flex-col bg-base-100">
   ```

### æ•ˆæœ

- æ•´ä¸ªåº”ç”¨é«˜åº¦ = è§†å£é«˜åº¦ï¼ˆæ— å¤–å±‚æ»šåŠ¨æ¡ï¼‰
- ChatList è‡ªåŠ¨è®¡ç®—å‰©ä½™é«˜åº¦å¹¶å†…éƒ¨æ»šåŠ¨
- è¾“å…¥æ¡†å§‹ç»ˆå›ºå®šåœ¨åº•éƒ¨

---

## ä½ çš„ä»»åŠ¡

æŒ‰ä»¥ä¸‹é¡ºåºæ”¹é€ ç»„ä»¶ï¼š

1. **MessageBubble** - ä½¿ç”¨ daisyUI `chat` ç»„ä»¶
2. **ChatList** - ä½¿ç”¨ Tailwind å·¥å…·ç±»
3. **ModeSelector** - ä½¿ç”¨ daisyUI `btn` ç»„ä»¶
4. **MarkdownRenderer** - æ›´æ–° CSS ä½¿ç”¨ daisyUI å˜é‡

æ¯å®Œæˆä¸€ä¸ªç»„ä»¶ï¼Œåˆ é™¤å¯¹åº”çš„ `.module.css` æ–‡ä»¶ã€‚

å®Œæˆåå‘Šè¯‰æˆ‘ï¼š"æˆ‘å†™å¥½äº†ï¼Œä½ æ£€æŸ¥ä¸€ä¸‹ @apps/client/src/components/..."
