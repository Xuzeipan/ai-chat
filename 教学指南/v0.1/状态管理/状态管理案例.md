# 状态管理案例

## 1. 什么是状态管理？

**状态（State）**：组件内部可以变化的数据
**状态管理**：管理和更新这些数据的方式

### 简单理解
- 状态 = 组件的"记忆"
- 状态变化 = 组件重新渲染
- 状态管理 = 控制数据如何变化

## 2. App 组件状态管理

### 文件：src/App.tsx

```typescript
import { useState } from 'react';
import type { ChatState } from './types';
import { ChatList } from './components/ChatList';
import { ChatInput } from './components/ChatInput';
import styles from './App.module.css';

function App() {
  // 管理聊天状态
  const [state, setState] = useState<ChatState>({
    messages: [],
    loading: false,
    error: null,
  });

  // 发送消息处理函数
  const handleSend = async (content: string) => {
    // 1. 添加用户消息
    const userMessage = {
      id: Date.now().toString(),
      role: 'user' as const,
      content,
    };

    setState((prev) => ({
      ...prev,
      messages: [...prev.messages, userMessage],
      loading: true,
      error: null,
    }));

    // 2. 模拟 API 请求（后续会替换为真实请求）
    try {
      // 模拟延迟
      await new Promise((resolve) => setTimeout(resolve, 1000));

      // 模拟 AI 回复
      const assistantMessage = {
        id: (Date.now() + 1).toString(),
        role: 'assistant' as const,
        content: `你刚才说：${content}`,
      };

      setState((prev) => ({
        ...prev,
        messages: [...prev.messages, assistantMessage],
        loading: false,
      }));
    } catch (error) {
      setState((prev) => ({
        ...prev,
        loading: false,
        error: '发送失败，请重试',
      }));
    }
  };

  return (
    <div className={styles.app}>
      <div className={styles.header}>AI 聊天</div>
      <ChatList messages={state.messages} />
      <ChatInput onSend={handleSend} isLoading={state.loading} />
    </div>
  );
}

export default App;
```

## 3. 样式文件：src/App.module.css

```css
.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background-color: #f5f5f5;
}

.header {
  padding: 16px;
  background-color: white;
  border-bottom: 1px solid #e0e0e0;
  font-size: 18px;
  font-weight: 600;
  text-align: center;
}
```

## 4. 代码解析

### useState 基础
```typescript
const [state, setState] = useState<ChatState>({
  messages: [],
  loading: false,
  error: null,
});
```
- `state`：当前状态值
- `setState`：更新状态的函数
- `useState<ChatState>`：指定状态类型

### 函数式更新
```typescript
setState((prev) => ({
  ...prev,
  messages: [...prev.messages, newMessage],
}));
```
- 使用函数式更新确保基于最新状态
- `...prev` 展开旧状态
- 只修改需要变更的属性

### 异步操作流程
```typescript
const handleSend = async (content: string) => {
  // 1. 更新状态：添加用户消息，显示 loading
  setState((prev) => ({ ...prev, messages: [...prev.messages, userMessage], loading: true }));

  // 2. 发送请求
  const response = await fetch('/api/chat');

  // 3. 更新状态：添加 AI 回复，隐藏 loading
  setState((prev) => ({ ...prev, messages: [...prev.messages, assistantMessage], loading: false }));
};
```

### 错误处理
```typescript
try {
  // 尝试发送请求
  await sendMessage(content);
} catch (error) {
  // 捕获错误，更新状态
  setState((prev) => ({ ...prev, loading: false, error: '发送失败' }));
}
```

## 5. 状态更新模式

### 模式 1：直接更新
```typescript
// 适用于简单状态
const [count, setCount] = useState(0);
setCount(count + 1);
```

### 模式 2：函数式更新
```typescript
// 依赖于前一个状态时使用
const [messages, setMessages] = useState([]);
setMessages((prev) => [...prev, newMessage]);
```

### 模式 3：部分更新
```typescript
// 对象状态的部分更新
const [state, setState] = useState({ a: 1, b: 2 });
setState((prev) => ({ ...prev, b: 3 }));  // 只更新 b
```

## 6. 状态 vs Props

| 特性 | State | Props |
|------|-------|-------|
| 来源 | 组件内部 | 父组件传递 |
| 可变性 | 可以修改 | 只读 |
| 作用范围 | 当前组件 | 父子组件通信 |
| 用途 | 组件内部数据 | 组件间数据传递 |

## 7. 状态设计原则

### 1. 最小化状态
```typescript
// ❌ 不好的做法：冗余状态
const [firstName, setFirstName] = useState('张');
const [lastName, setLastName] = useState('三');
const [fullName, setFullName] = useState('张三');

// ✅ 好的做法：派生状态
const [firstName, setFirstName] = useState('张');
const [lastName, setLastName] = useState('三');
const fullName = `${firstName}${lastName}`;  // 计算得出
```

### 2. 相关状态合并
```typescript
// ❌ 不好的做法：分散的状态
const [messages, setMessages] = useState([]);
const [loading, setLoading] = useState(false);
const [error, setError] = useState(null);

// ✅ 好的做法：合并相关状态
const [chatState, setChatState] = useState({
  messages: [],
  loading: false,
  error: null,
});
```

### 3. 单一数据源
```typescript
// ✅ 状态应该在需要它的最低层级组件中
function App() {
  const [messages, setMessages] = useState([]);
  return <ChatList messages={messages} />;
}
```

## 8. 调试技巧

### 使用 useEffect 监听状态变化
```typescript
useEffect(() => {
  console.log('状态变化:', state);
}, [state]);
```

### 使用 React DevTools
- 安装 React DevTools 浏览器扩展
- 查看 Props 和 State
- 追踪状态变化历史

## 9. 你的任务

1. 修改 `src/App.tsx`，实现状态管理
2. 创建 `src/App.module.css`，添加样式
3. 测试：输入消息，查看是否能正常显示

完成后告诉我，我帮你检查！

## 10. 下一步预告

状态管理完成后，下一步是 **步骤 4：API 集成**，将模拟请求替换为真实的 API 调用。