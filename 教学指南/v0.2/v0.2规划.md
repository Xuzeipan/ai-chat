# v0.2 规划 - 模式系统 + 流式输出

## 功能需求

### 1. 模式系统
- 定义多个模式（普通聊天、前端导师、代码审查等）
- 模式切换功能
- 模式配置（系统提示、上下文长度等）

### 2. 上下文管理
- 滑动窗口（只发送最近 N 条消息）
- System Prompt 注入
- 上下文长度优化

### 3. 流式输出
- 实时显示 AI 回复内容
- 打字机效果
- 流式数据解析和渲染

## 实现步骤（按功能模块）

### 功能模块 1：模式系统

#### 步骤 1：类型定义
- 定义 Mode 接口
- 扩展 AppState 类型（添加 currentMode 和 modes）

#### 步骤 2：模式配置
- 定义 MODES 常量
- 配置预定义模式（普通聊天、前端导师、代码审查）

#### 步骤 3：ModeSelector 组件
- 创建模式选择器 UI
- 实现模式切换交互

#### 步骤 4：集成模式切换
- 在 App 中集成 ModeSelector
- 实现模式切换状态管理

### 功能模块 2：上下文管理

#### 步骤 5：getContext 函数
- 实现上下文管理逻辑
- 实现 System Prompt 注入
- 实现滑动窗口

#### 步骤 6：集成上下文管理
- 在发送消息时使用上下文
- 验证上下文传递正确

### 功能模块 3：流式输出

#### 步骤 7：流式类型定义
- 定义 StreamChunk 接口

#### 步骤 8：API 流式改造
- 实现 sendMessageStream 函数
- 处理流式响应

#### 步骤 9：集成流式输出
- 在状态管理中集成流式更新
- 实现实时显示效果

## 技术要点

### 1. System Prompt 的作用
- 定义角色：告诉模型"你是谁"
- 设定行为：规定模型如何回答
- 控制范围：限制模型的回答边界

### 2. 上下文窗口
- 为什么需要：模型有 token 限制（通常是 4096 或 8192）
- 滑动窗口：只保留最近 N 条对话
- 优化策略：根据模式动态调整上下文长度

### 3. 流式输出
- 原理：使用 ReadableStream API
- 优势：即时反馈、更好的体验、性能优化
- 实现要点：getReader、逐块解析、实时更新状态

## 测试验证

### 测试场景
1. **模式切换**：切换不同模式后，回答风格明显不同
2. **上下文传递**：验证上下文正确传递给 API
3. **系统提示**：验证 System Prompt 不泄露给用户
4. **上下文长度**：验证上下文长度控制有效
5. **流式输出**：内容逐字显示，有打字机效果
6. **错误处理**：流式输出过程中可以正确处理中断和错误

### 验证点
- ✅ 模式切换功能正常
- ✅ 上下文正确传递
- ✅ System Prompt 不泄露给用户
- ✅ 上下文长度控制有效
- ✅ 流式输出实时显示
- ✅ 流式输出错误处理正确

## 学习收获

1. 模块化开发：按功能模块组织代码
2. 系统提示工程：如何设计有效的 system prompt
3. 上下文管理：如何优化对话历史
4. 前端主导 AI：如何通过前端控制模型行为
5. 状态管理进阶：复杂状态的拆分和管理
6. 流式数据处理：如何处理和渲染流式 API 响应
7. 异步编程：使用 ReadableStream API 和回调函数处理异步流