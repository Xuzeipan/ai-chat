# AI 聊天项目 Monorepo 迁移指南

将现有的 React 18 用户端代码迁移到 pnpm workspace + Turborepo 架构。

## 前置准备

确保环境就绪：

```bash
# 安装 pnpm（如未安装）
npm install -g pnpm

# 进入项目根目录
cd my-ai-chat

# 备份当前代码（重要！）
git add .
git commit -m "backup: before monorepo migration"
\`\`\`

## 1. 创建目录结构

在项目根目录执行：

\`\`\`bash
# 创建文件夹
mkdir -p apps/web
mkdir -p packages/ui
mkdir -p packages/shared-types

# 创建 workspace 配置
touch pnpm-workspace.yaml
\`\`\`

## 2. 配置根目录 package.json

创建根目录 \`package.json\`：

\`\`\`json
{
  "name": "ai-chat-platform",
  "private": true,
  "version": "1.0.0",
  "scripts": {
    "dev": "turbo dev",
    "build": "turbo build",
    "clean": "turbo clean && rm -rf node_modules",
    "web": "pnpm --filter @ai-chat/web",
    "api": "pnpm --filter @ai-chat/api",
    "admin": "pnpm --filter @ai-chat/admin"
  },
  "devDependencies": {
    "turbo": "^2.0.0"
  },
  "packageManager": "pnpm@9.0.0"
}
\`\`\`

## 3. 配置 pnpm-workspace.yaml

编辑 \`pnpm-workspace.yaml\`：

\`\`\`yaml
packages:
  - 'apps/*'
  - 'packages/*'
\`\`\`

## 4. 迁移现有代码

假设当前结构：
\`\`\`
my-ai-chat/
├── src/
├── public/
├── package.json
├── vite.config.ts
└── ...
\`\`\`

执行迁移命令：

\`\`\`bash
# 移动文件到 apps/web（排除 node_modules 和 .git）
mv src apps/web/
mv public apps/web/
mv package.json apps/web/
mv vite.config.* apps/web/ 2&gt;/dev/null || true
mv tsconfig.* apps/web/ 2&gt;/dev/null || true
mv index.html apps/web/ 2&gt;/dev/null || true
mv .env* apps/web/ 2&gt;/dev/null || true
mv .eslintrc* apps/web/ 2&gt;/dev/null || true
mv tailwind.config.* apps/web/ 2&gt;/dev/null || true
mv postcss.config.* apps/web/ 2&gt;/dev/null || true
\`\`\`

## 5. 修改 apps/web/package.json

关键：修改 **name** 字段：

\`\`\`json
{
  "name": "@ai-chat/web",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "clean": "rm -rf dist node_modules"
  },
  "dependencies": {
    "react": "^18.0.0",
    "react-dom": "^18.0.0"
  },
  "devDependencies": {
    "@types/react": "^18.0.0",
    "@types/react-dom": "^18.0.0",
    "@vitejs/plugin-react": "^4.0.0",
    "typescript": "^5.0.0",
    "vite": "^5.0.0"
  }
}
\`\`\`

## 6. 初始化共享包（占位）

### packages/ui/package.json
\`\`\`json
{
  "name": "@ai-chat/ui",
  "version": "0.0.1",
  "private": true,
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "scripts": {
    "clean": "rm -rf node_modules"
  }
}
\`\`\`

### packages/shared-types/package.json
\`\`\`json
{
  "name": "@ai-chat/shared-types",
  "version": "0.0.1",
  "private": true,
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "scripts": {
    "clean": "rm -rf node_modules"
  }
}
\`\`\`

### 创建入口文件
\`\`\`bash
mkdir -p packages/ui/src/components
mkdir -p packages/shared-types/src

touch packages/ui/src/index.ts
echo "export {};" &gt; packages/ui/src/index.ts

touch packages/shared-types/src/index.ts
echo "export {};" &gt; packages/shared-types/src/index.ts
\`\`\`

## 7. 安装依赖并验证

\`\`\`bash
# 安装所有依赖
pnpm install

# 启动用户端验证
pnpm web dev
\`\`\`

成功标志：应用正常启动（http://localhost:5173 或 3000）

## 8. 配置 Turborepo（可选但推荐）

\`\`\`bash
pnpm add -D turbo
\`\`\`

创建根目录 \`turbo.json\`：

\`\`\`json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*local"],
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "!.next/cache/**", "dist/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "clean": {
      "cache": false
    }
  }
}
\`\`\`

## 9. 最终检查

\`\`\`bash
# 清理旧依赖（如有残留）
rm -rf node_modules 2&gt;/dev/null || true
pnpm install

# 测试构建
pnpm web build

# 提交
git add .
git commit -m "chore: migrate to monorepo structure"
\`\`\`

## 最终目录结构

\`\`\`
ai-chat-platform/
├── apps/
│   └── web/                 # 你现有的 React 18 代码
│       ├── src/
│       ├── public/
│       ├── package.json     # name: @ai-chat/web
│       └── vite.config.ts
├── packages/
│   ├── ui/                  # 预留：shadcn/ui 组件
│   │   ├── src/index.ts
│   │   └── package.json     # name: @ai-chat/ui
│   └── shared-types/        # 预留：共享类型
│       ├── src/index.ts
│       └── package.json     # name: @ai-chat/types
├── package.json             # 根配置
├── pnpm-workspace.yaml
├── turbo.json
└── pnpm-lock.yaml
\`\`\`

## 下一步

1. 在 \`packages/ui\` 中初始化 shadcn/ui
2. 创建 \`apps/api\` 作为服务端
3. 创建 \`apps/admin\` 作为管理端

## 常见问题

**Q: 提示找不到模块？**
A: 运行 \`pnpm install\` 确保 apps/web/node_modules 存在

**Q: 路径别名 (@/components) 失效？**
A: 检查 vite.config.ts 中的 resolve.alias 是否仍指向正确目录

**Q: TypeScript 报错？**
A: 确保 tsconfig.json 中的 baseUrl 和 paths 保持原样，因为是相对 src 目录的